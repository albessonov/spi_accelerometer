/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2024 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <string.h>
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define CRC_POLY  0x12F
#define SPI_DATA_LEN_BITS 32
#define CRC_SPI_SEED 0xFF
#define CRC_LEN 8
#define MSG_LEN 32
#define CRC_SEED 0xFF
#define MAX_CRC 0xFF
#define MAX_UINT64_T 0xFFFFFFFFFFFFFFFF
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

SPI_HandleTypeDef hspi1;
DMA_HandleTypeDef hdma_spi1_rx;
DMA_HandleTypeDef hdma_spi1_tx;

TIM_HandleTypeDef htim1;

/* USER CODE BEGIN PV */
uint16_t ctr0=0;
uint16_t ctr2=0;
uint8_t RXbuf[4]={0,0,0,0};
uint8_t resp[4]={0,0,0,0};
const double timeXbuf[801]={0.139910, 0.279820, 0.139910,0.000000,0.279820,-0.139910,0.559640,-0.139910,0.279820,0.419730,0.279820,0.000000,0.000000,0.139910,0.139910,0.279820,0.419730,0.279820,-0.139910,-0.279820,0.139910,0.279820,-0.139910,0.279820,-0.419730,0.139910,-0.559640,0.559640,0.139910,0.699550,-0.419730,-0.139910,0.000000,-0.559640,0.279820,0.559640,0.000000,0.000000,-0.559640,0.419730,-0.419730,0.000000,-0.139910,-0.279820,0.839460,0.139910,-0.139910,0.000000,0.000000,-0.139910,0.279820,-0.559640,0.000000,-0.419730,0.000000,0.000000,-0.139910,0.279820,-0.139910,-0.279820,0.000000,-0.419730,-0.139910,-0.279820,-0.139910,-0.279820,0.139910,-0.419730,-0.139910,0.139910,0.279820,0.139910,-0.139910,0.139910,0.419730,-0.699550,0.279820,0.139910,-0.139910,0.559640,-0.139910,-0.419730,0.139910,-0.419730,0.000000,-0.139910,-0.279820,-0.139910,-0.279820,0.419730,-0.559640,0.000000,0.000000,-0.559640,0.839460,-0.839460,0.419730,-1.259190,-0.139910,-0.279820,0.559640,-0.139910,0.839460,-0.279820,0.000000,-0.139910,0.139910,-0.279820,-0.139910,0.000000,-0.139910,-0.279820,-0.559640,-0.139910,-0.279820,0.279820,0.139910,-0.699550,0.279820,-0.279820,0.139910,-0.139910,1.119280,-0.839460,-0.139910,-0.279820,-0.559640,0.419730,-0.559640,0.839460,-0.699550,0.139910,-0.139910,0.419730,0.000000,0.139910,0.279820,-0.279820,0.139910,0.279820,-0.279820,0.559640,-0.699550,-0.419730,-0.139910,0.419730,-0.279820,-0.139910,-0.279820,-0.139910,0.279820,-0.139910,0.419730,0.419730,0.419730,0.139910,0.139910,-0.139910,0.139910,0.279820,0.000000,0.139910,0.279820,0.139910,0.419730,0.139910,-0.139910,-0.139910,0.000000,-0.279820,0.279820,0.279820,0.000000,0.839460,0.139910,-0.139910,0.139910,0.000000,0.139910,0.559640,-0.559640,0.699550,-0.419730,0.559640,0.279820,0.139910,0.699550,-0.419730,0.419730,0.000000,0.419730,0.419730,-0.699550,0.559640,-0.139910,0.139910,0.839460,-0.419730,0.419730,-0.139910,0.419730,-0.699550,0.279820,0.279820,-0.839460,1.818830,-3.217930,1.539010,-0.279820,-14.410732,6.156041,-4.756941,1.259190,5.736311,-0.279820,-21.965873,18.608032,-9.513881,-8.394601,-4.756941,1.259190,-12.312082,-13.711182,3.777570,-3.777570,-11.892352,14.830462,-10.493251,-15.949742,-5.036761,-9.513881,-16.369472,-5.036761,-6.715681,-19.867223,-6.016131,-32.599034,18.468122,-34.837594,14.970372,6.435861,-1.958740,-9.234061,-3.078020,-12.731812,0.839460,3.917481,0.000000,-7.415231,-5.176671,-32.599034,-14.270822,-10.073521,2.098650,1.259190,-6.575771,-2.658290,-13.711182,-0.979370,2.518380,2.938110,2.938110,-13.571272,-0.419730,-7.555141,-10.073521,-13.291452,28.401734,-28.681554,1.119280,-12.451992,-11.332711,-1.818830,-12.451992,2.798200,-0.419730,-9.653791,-0.139910,-26.722813,9.933611,6.715681,-15.250192,-14.970372,17.208932,-12.032262,-27.282454,16.929112,-6.855591,-3.777570,6.295951,-15.949742,7.415231,-21.546143,-12.871722,-17.908482,11.052891,-10.353341,-7.695051,-4.756941,1.539010,10.353341,-15.530012,0.839460,9.513881,-39.594535,46.869856,-25.463623,6.016131,-3.637660,-13.011632,9.653791,-25.603533,7.135411,-3.497750,-14.970372,-2.938110,10.213431,-5.176671,-28.821464,1.818830,-20.007133,-2.518380,13.151542,-38.055525,24.064523,-29.660924,11.332711,-3.917481,-16.509382,13.571272,-20.286953,2.378470,-26.303083,1.119280,-44.631296,3.777570,-20.007133,-16.789202,5.036761,-19.307582,-16.089652,-10.633161,-38.335345,11.192801,-33.858224,13.151542,-31.060024,-10.912981,-14.130912,-15.390102,10.073521,-8.814331,-20.566773,-12.032262,-6.715681,-32.459124,22.105783,-41.133545,-3.917481,-17.488752,-21.825963,-12.312082,-18.747942,-18.468122,-24.484253,-42.112915,15.250192,-61.140678,21.406233,-17.768572,-22.805333,27.142544,-58.762208,-5.596401,-1.818830,-9.933611,-20.566773,-7.415231,-11.332711,-7.555141,-14.550642,-26.163173,5.596401,-23.784703,-14.830462,-23.364973,-6.575771,-8.674421,-15.390102,-15.809832,-23.085153,-12.172172,-21.546143,-13.991002,-17.208932,-13.851092,-18.188302,-17.908482,-8.254691,-19.167672,-19.447493,-18.048392,-3.357840,-13.851092,-14.410732,-14.550642,-4.896851,-16.649292,-12.871722,-13.291452,-6.995501,-9.653791,-9.373971,-22.805333,-3.917481,-6.295951,-15.530012,-12.871722,-7.695051,-6.995501,-9.094151,-6.295951,-10.213431,-12.731812,5.736311,-9.653791,-4.896851,10.493251,-19.587403,20.007133,-24.204433,14.830462,-22.665423,6.715681,-14.830462,-5.596401,-2.238560,-4.057391,-3.357840,-11.612531,8.814331,-5.176671,4.896851,-13.431362,6.016131,-14.970372,1.678920,-9.234061,4.337211,-9.653791,1.399100,-8.814331,8.114781,-7.834961,6.715681,-11.332711,7.834961,-10.493251,9.373971,-12.032262,10.213431,-11.612531,4.896851,-8.674421,7.695051,-11.052891,3.497750,-6.295951,6.435861,-2.098650,5.316581,-6.575771,6.156041,-8.674421,6.715681,-4.057391,7.695051,-18.048392,11.892352,-7.135411,5.176671,-1.818830,5.456491,-5.316581,-2.098650,-0.699550,-3.357840,0.279820,0.699550,1.958740,-5.736311,3.217930,-3.357840,2.238560,-2.378470,1.259190,3.497750,-4.057391,-5.176671,10.213431,-7.135411,5.736311,0.699550,4.477121,-6.435861,5.456491,-5.316581,2.798200,-8.394601,2.798200,-5.176671,0.139910,3.357840,1.818830,-2.378470,0.139910,-4.197301,5.036761,-3.917481,-1.678920,5.736311,-3.917481,1.958740,-3.217930,1.119280,-1.818830,-3.497750,3.497750,2.238560,1.259190,3.497750,-3.078020,1.259190,-3.917481,2.098650,-0.979370,3.217930,1.119280,0.419730,-0.139910,-1.119280,0.839460,-1.399100,1.818830,-0.559640,0.139910,3.078020,-1.399100,1.539010,-1.259190,1.119280,-0.839460,0.419730,0.699550,-0.559640,0.699550,-0.559640,0.279820,-0.559640,-0.139910,2.938110,0.979370,1.399100,-1.539010,0.839460,1.818830,-3.917481,6.715681,-3.637660,2.658290,1.119280,-1.539010,3.917481,-2.098650,4.197301,-0.979370,-2.938110,0.979370,-0.559640,-0.559640,1.399100,-1.119280,-0.699550,0.979370,-2.098650,0.979370,0.979370,-0.559640,-0.979370,-2.238560,-1.678920,-1.818830,-1.119280,1.958740,-1.958740,0.699550,-0.139910,0.139910,0.139910,-3.637660,0.979370,-0.839460,-0.839460,0.979370,-2.238560,0.000000,-2.378470,2.098650,-2.378470,-2.098650,0.139910,-1.119280,-0.699550,-0.979370,-0.139910,-0.559640,0.139910,-1.119280,-1.259190,0.839460,-1.539010,1.818830,-1.818830,1.119280,0.139910,-0.699550,0.699550,-0.839460,0.139910,-1.259190,0.279820,-1.958740,-0.139910,-0.839460,-0.979370,0.000000,0.139910,0.279820,0.139910,-0.559640,0.000000,0.699550,-0.839460,-0.139910,-1.399100,1.259190,-1.119280,-0.979370,-1.119280,-3.357840,0.000000,-0.559640,0.139910,-0.139910,-0.559640,0.139910,-0.979370,0.419730,0.559640,-0.419730,0.139910,0.279820,-1.958740,0.419730,-0.699550,0.559640,-0.559640,-0.279820,-0.979370,-0.979370,-0.839460,-0.979370,0.000000,0.000000,0.139910,-1.399100,-0.419730,-0.979370,-0.279820,-0.839460,0.279820,0.839460,-0.419730,0.139910,1.678920,-0.699550,-0.139910,-0.279820,-0.699550,0.979370,0.559640,0.979370,0.839460,-0.139910,0.979370,0.279820,0.559640,0.559640,-0.839460,-0.559640,0.000000,-1.399100,-1.259190,-0.839460,-0.699550,-0.139910,-0.559640,-0.139910,0.559640,0.559640,0.419730,0.279820,-0.419730,-0.559640,0.419730,0.000000,0.000000,0.699550,-0.419730,-0.139910,-0.139910,0.139910,0.139910,0.139910,0.559640,0.559640,0.699550,0.699550,0.139910,-0.279820,-1.259190,-2.798200,3.357840,-1.399100,0.979370,1.539010,-2.238560,1.259190,0.839460,0.559640,0.139910,-0.559640,3.637660,-0.699550,0.000000,-2.238560,0.279820,0.979370,-0.699550,-0.559640,-0.559640,-0.279820,0.419730,-0.839460,0.279820,0.559640,-0.279820,0.000000,-0.699550,0.559640,-0.279820,0.279820,0.559640,-1.119280,0.419730,-0.139910,-0.279820,-0.839460,-0.139910,-0.419730,0.000000,-0.839460,-0.139910,0.419730,0.139910,0.559640,-0.839460,-0.419730,-0.279820,-0.559640,0.279820,-0.279820,0.000000,-0.979370,-0.139910,0.000000,0.000000,0.139910,-0.139910,0.000000,-0.419730,0.279820,0.419730,0.000000,0.139910,-1.119280,0.139910,-0.699550,-0.699550,-0.419730,-0.419730};
const double timeYbuf[801]={-0.684152,-0.273661,-0.410491,-0.410491,0.136830,0.000000,-0.410491,0.136830,0.273661,0.000000,0.410491,0.000000,-0.136830,0.000000,0.000000,0.000000,-0.273661,-0.136830,0.136830,0.000000,0.684152,0.136830,0.000000,-0.547322,-0.273661,-0.273661,0.136830,-0.136830,-0.410491,-0.273661,-0.273661,0.136830,0.273661,-0.547322,-0.547322,-0.136830,-0.136830,-0.273661,-0.273661,0.273661,-0.136830,0.000000,-0.136830,0.000000,0.410491,0.136830,-0.410491,-0.136830,0.136830,0.273661,-0.273661,0.000000,-0.136830,-0.136830,-0.547322,-0.410491,0.410491,0.820983,-0.136830,-0.136830,-0.273661,0.273661,0.000000,-0.136830,0.000000,-0.136830,0.136830,-0.136830,-0.547322,-0.410491,0.547322,0.136830,-0.410491,0.410491,0.273661,-0.957813,0.136830,-0.273661,-0.273661,0.000000,0.000000,-0.273661,-0.136830,-0.410491,-0.273661,-0.273661,0.410491,-0.684152,-0.136830,-0.136830,-0.410491,-0.410491,-0.410491,0.136830,0.547322,0.273661,-0.136830,-0.273661,-0.410491,0.136830,0.273661,0.410491,-0.136830,0.000000,-0.136830,0.136830,0.000000,-0.136830,0.273661,-0.410491,-0.136830,-0.136830,-0.136830,-0.273661,-0.273661,-0.136830,0.000000,-0.684152,-0.547322,0.136830,-0.684152,0.136830,0.000000,-0.547322,0.000000,-0.136830,-0.273661,0.410491,-0.136830,0.273661,0.000000,0.136830,0.000000,-0.410491,0.273661,0.000000,0.273661,-0.273661,-0.273661,0.410491,0.000000,0.273661,-0.547322,0.000000,-0.273661,-0.273661,0.000000,0.410491,-0.136830,-0.136830,0.273661,0.136830,-0.547322,0.273661,0.136830,0.000000,0.410491,0.273661,0.410491,0.136830,0.000000,0.273661,0.136830,-0.410491,0.000000,0.410491,0.273661,-0.136830,-0.273661,-0.136830,0.000000,0.273661,0.136830,0.547322,-0.273661,-0.136830,0.000000,-0.136830,0.820983,-0.547322,0.136830,0.547322,0.000000,0.000000,0.547322,0.000000,0.273661,0.136830,0.410491,0.000000,0.000000,0.410491,-0.136830,0.957813,-0.410491,0.547322,0.000000,-0.136830,0.000000,0.273661,0.136830,0.000000,0.000000,0.000000,0.136830,1.231474,1.368304,1.231474,2.052456,1.641965,4.925895,6.431030,-7.115182,3.010269,-10.125451,5.199556,-1.505135,12.177907,5.610047,1.915626,-0.273661,1.778795,7.388843,9.714960,-0.820983,7.525673,10.535942,-8.757147,1.778795,-0.684152,15.872329,1.505135,25.176797,-14.777685,23.124341,-8.483486,2.873439,6.841521,4.241743,12.451568,-15.872329,-0.957813,-10.262281,-7.799334,6.020538,20.935054,34.618096,4.104913,-2.736608,-6.157369,8.893977,14.777685,25.176797,7.662503,13.546211,5.336386,-9.304468,6.567860,11.630586,8.620316,-5.336386,10.672773,1.505135,-18.335276,2.873439,29.281710,36.944213,2.599778,6.704691,-14.230364,-9.578129,2.599778,25.724119,2.052456,9.988621,7.252012,-7.388843,3.968082,-2.462948,7.252012,19.566750,6.567860,23.808493,8.620316,0.820983,2.599778,13.683042,20.387732,0.136830,23.671662,-6.567860,-1.641965,-10.399112,11.220094,5.199556,-6.841521,8.483486,31.881488,9.578129,4.789065,15.461837,6.978351,17.514294,18.335276,-2.189287,28.187066,0.820983,16.145989,9.167638,17.651124,21.619206,-16.830142,2.189287,20.798224,8.893977,14.093533,5.062725,14.914516,-7.388843,28.323897,-6.841521,-1.505135,7.252012,-8.893977,28.187066,5.610047,45.975021,19.840411,9.304468,7.936164,19.019428,4.925895,26.818762,2.052456,26.271440,22.987510,40.638634,28.734388,11.767416,42.417430,15.598668,11.083264,-6.704691,43.375243,6.157369,3.694421,51.037746,3.283930,0.273661,-5.336386,30.786844,23.534832,-12.588399,30.102692,6.704691,10.672773,11.767416,10.262281,12.177907,17.514294,8.757147,22.987510,0.273661,2.462948,26.955592,22.166528,17.924785,-21.482376,27.913405,16.282820,5.062725,39.680821,5.610047,8.893977,22.029697,13.272551,14.230364,12.588399,24.903136,19.156259,12.998890,12.588399,12.177907,14.640855,13.956703,31.470996,13.135720,15.051346,8.072995,21.345545,21.071884,20.935054,18.472107,12.177907,13.409381,16.556481,21.892867,20.387732,11.767416,9.167638,18.745767,20.661393,17.787954,15.325007,13.272551,11.356925,20.114072,13.819872,19.977241,24.903136,23.124341,16.830142,11.767416,17.651124,22.577019,21.619206,15.051346,34.891757,12.862059,18.608937,9.304468,17.103802,14.640855,7.115182,28.050236,5.199556,17.240633,1.094643,31.744657,18.198446,14.914516,16.830142,8.893977,16.966972,12.177907,13.135720,7.525673,10.809603,11.493755,6.294199,7.252012,11.220094,6.704691,12.862059,3.694421,11.356925,4.789065,11.904246,6.294199,9.167638,7.936164,12.862059,11.083264,7.799334,2.599778,6.020538,9.851790,7.525673,6.704691,8.483486,3.968082,7.115182,1.641965,7.662503,-1.231474,-0.273661,6.431030,1.231474,7.525673,1.368304,6.431030,-4.925895,7.115182,1.368304,-6.704691,10.399112,-0.136830,5.062725,-2.462948,-2.326117,2.326117,3.694421,6.431030,-1.778795,6.157369,-3.557591,-1.368304,2.052456,6.294199,4.515404,-3.557591,-3.557591,-1.231474,-1.641965,2.736608,7.799334,6.567860,-6.431030,-2.599778,-0.273661,-3.010269,7.662503,-1.094643,-1.094643,-2.189287,0.820983,4.789065,-7.388843,-0.410491,-1.231474,-0.273661,0.547322,0.410491,3.831252,1.505135,1.368304,-6.431030,-0.820983,-2.736608,3.147100,1.915626,1.368304,1.094643,-2.736608,-0.273661,-3.010269,0.273661,1.915626,1.778795,2.189287,-2.736608,-0.410491,-2.052456,0.273661,0.273661,-0.410491,0.957813,-2.052456,0.273661,-2.873439,-0.410491,-1.915626,-2.736608,-1.094643,-2.326117,0.273661,-0.136830,-0.957813,-0.957813,-2.736608,-0.957813,-3.147100,-0.136830,0.547322,-1.231474,-0.820983,-2.462948,-0.547322,-0.820983,0.820983,-0.547322,-1.231474,-0.957813,-0.957813,-2.599778,-3.010269,1.641965,2.462948,-3.147100,-1.505135,-1.368304,1.094643,0.136830,-1.641965,0.273661,-0.684152,-1.231474,-1.505135,1.505135,0.000000,2.599778,-0.820983,-0.410491,-0.957813,-1.368304,1.368304,0.410491,0.957813,-0.547322,0.547322,1.778795,-0.957813,0.410491,1.505135,2.052456,0.136830,-0.547322,-1.231474,1.368304,-0.957813,-1.094643,-0.410491,0.547322,-0.136830,-0.136830,0.547322,0.547322,-0.136830,0.547322,2.873439,0.136830,1.368304,-0.410491,0.957813,0.547322,-1.094643,-0.410491,-0.410491,2.189287,-1.915626,0.410491,1.094643,0.957813,-1.094643,0.273661,0.684152,2.326117,0.273661,-0.820983,-1.094643,0.136830,-2.189287,0.000000,0.000000,0.136830,-1.231474,-1.231474,0.136830,0.684152,0.000000,0.410491,0.000000,-0.136830,-0.820983,-0.547322,1.641965,0.547322,1.231474,-1.094643,-0.684152,-0.273661,0.684152,-0.684152,0.136830,-0.273661,-0.684152,-1.641965,0.000000,0.684152,1.094643,0.273661,0.273661,-0.684152,-0.273661,-0.684152,1.368304,1.094643,0.684152,-0.820983,-0.410491,0.136830,-0.273661,-0.273661,0.136830,0.273661,-0.957813,-0.820983,-1.641965,0.410491,1.368304,0.684152,0.000000,-0.410491,-0.273661,-1.368304,-1.094643,0.410491,1.641965,1.094643,-0.547322,-1.094643,0.410491,-0.136830,-0.684152,0.000000,0.410491,-0.273661,-0.136830,0.410491,-0.273661,0.410491,-0.820983,-0.684152,0.273661,0.136830,-0.410491,0.684152,0.957813,-0.136830,-0.273661,-0.684152,0.136830,0.273661,0.000000,0.410491,0.273661,0.410491,-0.410491,0.547322,0.820983,0.136830,0.000000,0.273661,0.136830,-0.136830,-0.273661,0.136830,-0.136830,0.957813,0.410491,-0.273661,-3.420760,3.283930,-0.547322,-2.052456,2.462948,0.957813,-0.410491,-2.736608,3.557591,0.957813,-2.052456,1.641965,-0.547322,0.410491,-3.283930,0.547322,0.957813,0.000000,-0.136830,-1.231474,0.957813,-0.820983,0.684152,-0.273661,0.957813,0.000000,0.000000,0.136830,-0.273661,0.000000,-0.136830,0.684152,-0.684152,-0.547322,0.273661,-0.136830,0.273661,0.547322,0.684152,-0.547322,0.000000,0.410491,0.684152,0.273661,0.273661,0.000000,-0.547322,0.136830,-0.410491,0.136830,0.684152,0.820983,0.547322,-0.410491,-0.136830,0.410491,0.136830,1.231474,0.273661,0.136830,-0.547322,0.000000,-0.136830,0.000000,-0.410491,0.547322,-0.273661,0.000000,-0.273661,-0.136830};
const uint8_t Request0x0cmd[]={0x10,0x00,0x00,0x0d};
const uint8_t Request0x2cmd[]={0x50,0x00,0x00,0xfc};
double timeX=-100.5,timeY=-100.5;
uint8_t RCOMMAND0x00=0b10000100;
uint8_t RCOMMAND0x02=0b10100100;
uint16_t collision,ISR,TTF;

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_SPI1_Init(void);
static void MX_TIM1_Init(void);
/* USER CODE BEGIN PFP */
static uint8_t CRC8(uint32_t SPI_data);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */
  
  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_SPI1_Init();
  MX_TIM1_Init();
  /* USER CODE BEGIN 2 */
  HAL_TIM_Base_Start(&htim1);
  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
		if(timeX==0)
		{
		  HAL_GPIO_WritePin(GPIOC,GPIO_PIN_9,GPIO_PIN_SET);
			collision=TIM1->CNT;
		}
		HAL_SPI_Receive_IT(&hspi1,RXbuf,4);
		
		if(timeX==300||timeY==300) break;
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Supply configuration update enable
  */
  HAL_PWREx_ConfigSupply(PWR_LDO_SUPPLY);

  /** Configure the main internal regulator output voltage
  */
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  while(!__HAL_PWR_GET_FLAG(PWR_FLAG_VOSRDY)) {}

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 3;
  RCC_OscInitStruct.PLL.PLLN = 50;
  RCC_OscInitStruct.PLL.PLLP = 2;
  RCC_OscInitStruct.PLL.PLLQ = 2;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLRGE = RCC_PLL1VCIRANGE_3;
  RCC_OscInitStruct.PLL.PLLVCOSEL = RCC_PLL1VCOWIDE;
  RCC_OscInitStruct.PLL.PLLFRACN = 0;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2
                              |RCC_CLOCKTYPE_D3PCLK1|RCC_CLOCKTYPE_D1PCLK1;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.SYSCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB3CLKDivider = RCC_APB3_DIV2;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_APB1_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_APB2_DIV2;
  RCC_ClkInitStruct.APB4CLKDivider = RCC_APB4_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief SPI1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_SPI1_Init(void)
{

  /* USER CODE BEGIN SPI1_Init 0 */

  /* USER CODE END SPI1_Init 0 */

  /* USER CODE BEGIN SPI1_Init 1 */

  /* USER CODE END SPI1_Init 1 */
  /* SPI1 parameter configuration*/
  hspi1.Instance = SPI1;
  hspi1.Init.Mode = SPI_MODE_SLAVE;
  hspi1.Init.Direction = SPI_DIRECTION_2LINES;
  hspi1.Init.DataSize = SPI_DATASIZE_8BIT;
  hspi1.Init.CLKPolarity = SPI_POLARITY_LOW;
  hspi1.Init.CLKPhase = SPI_PHASE_1EDGE;
  hspi1.Init.NSS = SPI_NSS_HARD_INPUT;
  hspi1.Init.FirstBit = SPI_FIRSTBIT_MSB;
  hspi1.Init.TIMode = SPI_TIMODE_DISABLE;
  hspi1.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE;
  hspi1.Init.CRCPolynomial = 0x0;
  hspi1.Init.NSSPMode = SPI_NSS_PULSE_DISABLE;
  hspi1.Init.NSSPolarity = SPI_NSS_POLARITY_LOW;
  hspi1.Init.FifoThreshold = SPI_FIFO_THRESHOLD_01DATA;
  hspi1.Init.TxCRCInitializationPattern = SPI_CRC_INITIALIZATION_ALL_ZERO_PATTERN;
  hspi1.Init.RxCRCInitializationPattern = SPI_CRC_INITIALIZATION_ALL_ZERO_PATTERN;
  hspi1.Init.MasterSSIdleness = SPI_MASTER_SS_IDLENESS_00CYCLE;
  hspi1.Init.MasterInterDataIdleness = SPI_MASTER_INTERDATA_IDLENESS_00CYCLE;
  hspi1.Init.MasterReceiverAutoSusp = SPI_MASTER_RX_AUTOSUSP_DISABLE;
  hspi1.Init.MasterKeepIOState = SPI_MASTER_KEEP_IO_STATE_DISABLE;
  hspi1.Init.IOSwap = SPI_IO_SWAP_DISABLE;
  if (HAL_SPI_Init(&hspi1) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN SPI1_Init 2 */

  /* USER CODE END SPI1_Init 2 */

}

/**
  * @brief TIM1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM1_Init(void)
{

  /* USER CODE BEGIN TIM1_Init 0 */

  /* USER CODE END TIM1_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM1_Init 1 */

  /* USER CODE END TIM1_Init 1 */
  htim1.Instance = TIM1;
  htim1.Init.Prescaler = 199;
  htim1.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim1.Init.Period = 65535;
  htim1.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim1.Init.RepetitionCounter = 0;
  htim1.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim1) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim1, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterOutputTrigger2 = TIM_TRGO2_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim1, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM1_Init 2 */

  /* USER CODE END TIM1_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Stream0_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Stream0_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Stream0_IRQn);
  /* DMA1_Stream1_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Stream1_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Stream1_IRQn);

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOC_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOC, GPIO_PIN_9, GPIO_PIN_RESET);

  /*Configure GPIO pin : PC9 */
  GPIO_InitStruct.Pin = GPIO_PIN_9;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /*Configure GPIO pin : PC10 */
  GPIO_InitStruct.Pin = GPIO_PIN_10;
  GPIO_InitStruct.Mode = GPIO_MODE_IT_RISING;
  GPIO_InitStruct.Pull = GPIO_PULLDOWN;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /* EXTI interrupt init*/
  HAL_NVIC_SetPriority(EXTI15_10_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(EXTI15_10_IRQn);

/* USER CODE BEGIN MX_GPIO_Init_2 */
/* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */
static uint8_t CRC8(uint32_t SPI_data)
{
	uint64_t mask = MAX_UINT64_T - MAX_CRC;
	uint64_t rem = (uint64_t)((((uint64_t)SPI_data) | (((uint64_t)CRC_SEED) << MSG_LEN)) & mask);
	uint64_t divider = ((uint64_t)CRC_POLY) << (MSG_LEN - 1);

	for (uint16_t i = MSG_LEN + CRC_LEN; i > 0; i--) //32 = 4*8
	{
		if (((rem >> (i - 1)) & 0x01) != 0)
		{
			rem ^= divider;
		}
		divider >>= 1;
		if ((rem & mask) == 0) //end of calc
		{
			break;
		}
	}
	// Return 8-bit CRC calculated
	return (uint8_t)(rem & MAX_CRC);
}
void HAL_SPI_RxCpltCallback(SPI_HandleTypeDef *hspi)
{
  if(hspi == &hspi1)
  {
    if(memcmp(RXbuf,Request0x0cmd,4)==0)
    { 
       timeX+=0.5;
		   uint8_t valH0,valL0,valL,valH;
		   double Num = timeXbuf[ctr0];
	     int16_t val=round(20.47*Num);
	     if(val>=0)
	     {
          valL0 = (uint8_t) ((val<<4) & 0x00ff);
          valH0 = (uint8_t) (((val<<4) & 0xff00) >> 8);
          valL=valL0;
          valH=valH0;
	     }
	     else
	     {
          valL0 = (uint8_t) (((-val)<<4) & 0x00ff);
          valH0 = (uint8_t) (((((-val)<<4) & 0xff00) >> 8));
          valL=~valL0+1;
          valH=~valH0;
	     }
         resp[0]=(RCOMMAND0x00|(valH>>6));
         resp[1]=((valH<<2)|(valL>>6));
         resp[2]=(valL<<2);
         resp[3]=CRC8((((uint32_t)resp[0])<<24)|(((uint32_t)resp[1])<<16)|(((uint32_t)resp[2])<<8));   
         ctr0+=1; 			 
    }
		else if (memcmp(RXbuf,Request0x2cmd,4)==0)
    {   
       timeY+=0.5;
		   uint8_t valH0,valL0,valL,valH;
		   double Num = timeXbuf[ctr2];
	     int16_t val=round(20.47*Num);
	     if(val>=0)
	     {
          valL0 = (uint8_t) ((val<<4) & 0x00ff);
          valH0 = (uint8_t) (((val<<4) & 0xff00) >> 8);
          valL=valL0;
          valH=valH0;
	     }
	     else
	     {
          valL0 = (uint8_t) (((-val)<<4) & 0x00ff);
          valH0 = (uint8_t) (((((-val)<<4) & 0xff00) >> 8));
          valL=~valL0+1;
          valH=~valH0;
	     }
         
         resp[0]=(RCOMMAND0x02|(valH>>6));
         resp[1]=((valH<<2)|(valL>>6));
         resp[2]=(valL<<2);
         resp[3]=CRC8((((uint32_t)resp[0])<<24)|(((uint32_t)resp[1])<<16)|(((uint32_t)resp[2])<<8));	       
         ctr2+=1;			 
    }
		HAL_SPI_Transmit_DMA(&hspi1,resp,4);
  }
}
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
	if(GPIO_Pin==GPIO_PIN_10)
	{
		ISR=TIM1->CNT;
		HAL_GPIO_WritePin(GPIOC,GPIO_PIN_9,GPIO_PIN_RESET);
		TTF=ISR-collision;
	}
}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
